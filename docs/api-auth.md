# 用户模块接口说明

本文档聚焦健康咨询平台的用户认证与验证码模块，描述 `/api/auth` 下已有接口的用途、请求参数、返回结构及关键业务约束。所有接口均返回统一响应包装 `ApiResponse<T>`，字段含义如下：

| 字段 | 类型 | 说明 |
| --- | --- | --- |
| success | boolean | 是否调用成功 |
| message | string | 失败时的提示信息，成功时为空 |
| data | object | 业务数据载荷，类型随接口而变 |
| timestamp | string | ISO-8601 时间戳 |

除验证码发送外，其余接口在需要鉴权时前端应通过 Header `x-token` 传递访问令牌。令牌由登录接口签发，刷新接口可延长有效期，退出接口支持主动失效令牌。

## 1. 发送登录验证码

- **Method & Path**：`POST /api/auth/otp`
- **用途**：向手机号发送一次性验证码，支持登录或绑定手机号场景，短信服务由后端调用外部适配层。
- **请求体字段**：

| 字段 | 类型 | 必填 | 说明 |
| --- | --- | --- | --- |
| phone | string | 是 | 用户手机号，需通过号段合法性校验；建议前端先做基础校验。 |
| purpose | string | 是 | 验证码用途，例如 `LOGIN`、`BIND_PHONE`，后端依用途选择短信模板与有效期。 |

- **响应体**：`ApiResponse<Void>`，`data` 恒为 `null`。
- **业务约束**：
  - 单手机号需结合外部限流策略控制发送频次（默认 60 秒内不可重复申请）。
  - 触发短信前需经过图形验证码或风控校验，相关 token 由调用方在同一请求中携带（如对接时新增字段）。

## 2. 校验验证码

- **Method & Path**：`POST /api/auth/otp/verify`
- **用途**：校验手机号与验证码的对应关系。
- **请求体字段**：

| 字段 | 类型 | 必填 | 说明 |
| --- | --- | --- | --- |
| phone | string | 是 | 与发送验证码时的手机号保持一致。 |
| purpose | string | 是 | 必须与发送验证码时的用途一致，否则视为无效验证码。 |
| code | string | 是 | 用户收到的验证码，默认 6 位数字。 |

- **响应体**：`ApiResponse<Boolean>`。

| data 字段 | 类型 | 说明 |
| --- | --- | --- |
| true/false | boolean | `true` 表示校验通过；`false` 不会返还，失败场景直接抛出业务异常并携带错误信息。 |

- **业务约束**：
  - 验证码默认 5 分钟有效，一个验证码单次使用即失效。
  - 验证失败计数需结合后端风控策略，连续失败达到阈值后临时封禁手机号。

## 3. 微信登录并签发令牌

- **Method & Path**：`POST /api/auth/login`
- **用途**：结合微信 `unionId` 与手机号完成用户注册或登录，签发访问令牌与刷新令牌。
- **请求体字段**：

| 字段 | 类型 | 必填 | 说明 |
| --- | --- | --- | --- |
| unionId | string | 是 | 微信提供的用户唯一标识，通过解密 `code` 与 session 获取。 |
| phone | string | 是 | 已通过短信验证码验证的手机号，作为账号主键之一。 |
| avatar | string | 否 | 用户头像 URL，若为空则保留历史头像。 |
| nickname | string | 否 | 用户昵称，用于展示与个性化推荐。 |

- **响应体**：`ApiResponse<AuthLoginResponse>`。

| data 字段 | 类型 | 说明 |
| --- | --- | --- |
| token | string | 访问令牌（JWT），默认有效期 30 分钟，需要在请求 Header `x-token` 中携带。 |
| refreshToken | string | 刷新令牌（UUID），默认有效期 7 天，用于续期访问令牌。 |
| userId | number | 用户主键 ID。 |
| phone | string | 当前绑定手机号。 |
| avatar | string | 最新头像地址（可能为空字符串）。 |

- **业务约束**：
  - 如果手机号已存在，会尝试合并账号信息；若 `unionId` 对应用户与手机号所有者不一致，返回失败提示。
  - 登录成功后需在客户端保存 `token` 与 `refreshToken`，后续调用业务接口时在 Header 附带 `x-token`。
  - 令牌有效期默认 30 分钟，可通过刷新接口续期。

## 4. 刷新访问令牌

- **Method & Path**：`POST /api/auth/refresh`
- **用途**：使用长期有效的刷新令牌获取新的访问令牌，避免频繁登录。
- **请求体字段**：

| 字段 | 类型 | 必填 | 说明 |
| --- | --- | --- | --- |
| refreshToken | string | 是 | 登录接口签发的刷新令牌，需与用户现有账号匹配。 |

- **响应体**：同登录接口，`data` 字段结构一致（`token`、`refreshToken`、`userId`、`phone`、`avatar`）。
- **业务约束**：
  - 刷新令牌默认 7 天有效，仅能续期一次；旧令牌在刷新成功后立即失效。
  - 若刷新令牌过期或不存在，接口返回失败，客户端需重新触发登录流程。

## 5. 退出登录

- **Method & Path**：`POST /api/auth/logout`
- **用途**：客户端主动请求退出，后端清理令牌缓存，防止后续被使用。
- **请求头**：

| Header | 类型 | 必填 | 说明 |
| --- | --- | --- | --- |
| x-token | string | 是 | 当前访问令牌，后端据此定位用户并作失效处理。 |

- **响应体**：`ApiResponse<Void>`。
- **业务约束**：
  - 退出操作是幂等的，即使令牌已失效也会返回成功。
  - 建议客户端在调用成功后清除本地缓存的 `token`、`refreshToken`，并重置用户态。

