<!--pages/inquiry-chat/inquiry-chat.wxml-->
<view class="flex-col page">
  <!-- 消息列表区域 -->
  <scroll-view
    class="message-list"
    scroll-y
    scroll-into-view="{{scrollToView}}"
    scroll-with-animation
    enhanced
    show-scrollbar="{{false}}"
    bindscrolltoupper="onScrollToUpper"
  >
    <!-- 加载更多历史提示 -->
    <view class="loading-more" wx:if="{{isLoadingHistory}}">
      <text class="loading-text">加载历史消息...</text>
    </view>
    <view class="history-tip" wx:elif="{{historyHasMore}}">
      <text class="history-tip-text">下拉加载更多历史</text>
    </view>

    <!-- 快捷问题提示（仅在首次显示） -->
    <view class="quick-questions" wx:if="{{messages.length <= 1 && initialized}}">
      <text class="quick-title">您可以尝试问我：</text>
      <view class="quick-list">
        <view
          class="quick-item"
          wx:for="{{quickQuestions}}"
          wx:key="index"
          data-question="{{item}}"
          bindtap="onQuickQuestion"
        >
          <text class="quick-text">{{item}}</text>
        </view>
      </view>
    </view>

    <!-- 消息列表 -->
    <view class="messages">
      <view
        class="message-item {{item.role === 'USER' ? 'user' : 'assistant'}}"
        wx:for="{{messages}}"
        wx:key="id"
        id="{{item.id}}"
      >
        <!-- 医生消息 -->
        <block wx:if="{{item.role === 'ASSISTANT'}}">
          <view class="avatar-wrap">
            <image class="avatar" src="{{doctor.avatar}}" mode="aspectFill"></image>
          </view>
          <view class="message-content">
            <view class="message-header">
              <text class="message-name">{{doctor.name}}</text>
              <text class="message-time">{{item.timestamp}}</text>
            </view>
            <view class="message-bubble assistant-bubble">
              <rich-text class="message-text md-content" nodes="{{item.htmlContent}}"></rich-text>
            </view>
          </view>
        </block>

        <!-- 用户消息 -->
        <block wx:if="{{item.role === 'USER'}}">
          <view class="avatar-wrap">
            <image class="avatar" src="/images/icons/avatar-user.svg" mode="aspectFill"></image>
          </view>
          <view class="message-content">
            <view class="message-header user-header">
              <text class="message-name">我</text>
              <text class="message-time">{{item.timestamp}}</text>
            </view>
            <view class="message-bubble user-bubble">
              <rich-text class="message-text user-text md-content" nodes="{{item.htmlContent}}"></rich-text>
            </view>
          </view>
        </block>
      </view>

      <!-- 正在输入提示 -->
      <view class="typing-indicator" wx:if="{{isSending}}">
        <view class="avatar-wrap">
          <image class="avatar" src="{{doctor.avatar}}" mode="aspectFill"></image>
        </view>
        <view class="typing-bubble">
          <view class="typing-dot"></view>
          <view class="typing-dot"></view>
          <view class="typing-dot"></view>
        </view>
      </view>
    </view>

    <!-- 底部占位 -->
    <view class="message-bottom"></view>
  </scroll-view>

  <!-- 底部输入区域 -->
  <view class="input-area">
    <view class="input-wrap">
      <input
        class="input"
        placeholder="请输入您的健康问题..."
        placeholder-class="input-placeholder"
        value="{{inputValue}}"
        bindinput="onInputChange"
        bindconfirm="onSend"
        confirm-type="send"
      />
      <view class="send-btn {{inputValue ? 'active' : ''}}" bindtap="onSend">
        <text class="send-text">发送</text>
      </view>
    </view>
    <!-- 安全区域 -->
    <view class="safe-area"></view>
  </view>
</view>
